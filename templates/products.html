{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">
                <i class="bi bi-box-seam me-2 text-primary"></i> Quản lý sản phẩm
            </h2>
            <p class="text-muted mb-0">Quản lý danh sách sản phẩm trong kho hàng</p>
        </div>
        <button class="btn btn-primary btn-lg shadow-sm rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="bi bi-plus-circle me-2"></i> Thêm sản phẩm
        </button>
    </div>

    <!-- Filters Card -->
    <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
        <div class="card-body p-4">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-lg-4 col-md-5">
                    <label class="form-label fw-medium text-muted small">Tìm kiếm</label>
                    <div class="position-relative">
                        <i class="bi bi-search position-absolute top-50 start-3 translate-middle-y text-muted"></i>
                        <input type="text" class="form-control ps-5 rounded-pill" name="search"
                               placeholder="Tên sản phẩm, SKU..." value="{{ search }}">
                    </div>
                </div>
                <div class="col-lg-2 col-md-3">
                    <label class="form-label fw-medium text-muted small">Danh mục</label>
                    <select class="form-select rounded-pill" name="category">
                        <option value="">Tất cả</option>
                        {% for cat in categories %}
                        <option value="{{ cat['category'] }}" {% if selected_category==cat['category'] %}selected{% endif %}>
                            {{ cat['category'] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-2 col-md-3">
                    <label class="form-label fw-medium text-muted small">Tồn kho</label>
                    <select class="form-select rounded-pill" name="min_stock">
                        <option value="">Tất cả</option>
                        <option value="5" {% if min_stock=='5' %}selected{% endif %}>Sắp hết (≤ 5)</option>
                        <option value="10" {% if min_stock=='10' %}selected{% endif %}>Thấp (≤ 10)</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-3 col-xl-1">
                    <button type="submit" class="btn btn-outline-primary w-100 rounded-pill">
                        <i class="bi bi-funnel me-1"></i> Lọc
                    </button>
                </div>
                <div class="col-lg-2 text-end">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" onclick="window.location.href='?'">
                        <i class="bi bi-arrow-clockwise"></i> Xóa lọc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Products Table Card -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0 py-3 px-4 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold text-dark">
                <i class="bi bi-list-ul me-2 text-primary"></i>
                Danh sách sản phẩm <span class="text-muted fw-normal">({{ products|length }})</span>
            </h5>
            <div class="btn-toolbar">
                <button class="btn btn-sm btn-outline-secondary me-2 rounded-pill" onclick="exportToCSV('productsTable', 'products.csv')">
                    <i class="bi bi-download me-1"></i> CSV
                </button>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="printPage()">
                    <i class="bi bi-printer me-1"></i> In
                </button>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0" id="productsTable">
                    <thead class="bg-light">
                        <tr>
                            <th class="text-muted small fw-semibold">#</th>
                            <th class="text-muted small fw-semibold">Sản phẩm</th>
                            <th class="text-muted small fw-semibold">SKU</th>
                            <th class="text-muted small fw-semibold">Danh mục</th>
                            <th class="text-muted small fw-semibold">Tồn kho</th>
                            <th class="text-muted small fw-semibold text-end">Giá (VNĐ)</th>
                            <th class="text-muted small fw-semibold">Vị trí</th>
                            <th class="text-muted small fw-semibold">Nhà cung cấp</th>
                            <th class="text-muted small fw-semibold">Trạng thái</th>
                            <th class="text-muted small fw-semibold text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr class="align-middle">
                            <td class="small">{{ loop.index }}</td>
                            <td>
                                <div class="fw-semibold">{{ product['name'] }}</div>
                                {% if product['description'] %}
                                <div class="text-muted small text-truncate" style="max-width: 200px;">
                                    {{ product['description'][:60] }}{% if product['description']|length > 60 %}...{% endif %}
                                </div>
                                {% endif %}
                            </td>
                            <td><code class="small bg-light px-2 py-1 rounded">{{ product['sku'] }}</code></td>
                            <td>
                                <span class="badge bg-primary-subtle text-primary rounded-pill">{{ product['category'] }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-3">{{ product['stock'] }}</span>
                                    <small class="text-muted">/ {{ product['min_stock'] }}</small>
                                </div>
                                <div class="progress mt-1" style="height: 6px; width: 100px;">
                                    <div class="progress-bar rounded-pill
                                        {% if product['stock'] <= product['min_stock'] %}bg-danger
                                        {% elif product['stock'] <= product['min_stock'] * 2 %}bg-warning
                                        {% else %}bg-success{% endif %}"
                                         style="width: {{ (product['stock'] / (product['min_stock'] * 3 if product['min_stock'] * 3 > 0 else 1) * 100)|round(0) }}%;">
                                    </div>
                                </div>
                            </td>
                            <td class="text-end fw-semibold text-primary">{{ "{:,.0f}".format(product['price'] or 0) }}</td>
                            <td>
                                <span class="badge bg-light text-dark rounded-pill small">
                                    <i class="bi bi-geo-alt me-1"></i>{{ product['location'] }}
                                </span>
                            </td>
                            <td class="small">{{ product['supplier'] or '-' }}</td>
                            <td>
                                {% if product['status'] == 'pending' %}
                                    <span class="badge bg-warning text-dark rounded-pill">
                                        <i class="bi bi-hourglass-split me-1"></i>Chờ duyệt
                                    </span>
                                {% elif product['status'] == 'rejected' %}
                                    <span class="badge bg-danger rounded-pill">Đã từ chối</span>
                                {% else %}
                                    {% if product['stock'] <= product['min_stock'] %}
                                        <span class="badge bg-danger rounded-pill">Sắp hết</span>
                                    {% elif product['stock'] <= product['min_stock'] * 2 %}
                                        <span class="badge bg-warning rounded-pill">Thấp</span>
                                    {% else %}
                                        <span class="badge bg-success rounded-pill">Đủ</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary rounded-pill px-3" 
                                            data-bs-toggle="modal" data-bs-target="#updateStockModal{{ product['id'] }}"
                                            title="Cập nhật tồn kho">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-info rounded-pill px-3"
                                            data-bs-toggle="modal" data-bs-target="#viewProductModal{{ product['id'] }}"
                                            title="Xem chi tiết">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    {% if user and user['role'] == 'admin' %}
                                    <a href="/products/{{ product['id'] }}/delete"
                                       class="btn btn-outline-danger rounded-pill px-3 btn-delete"
                                       title="Xóa sản phẩm">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                        <!-- Các modal giữ nguyên logic, chỉ tinh chỉnh giao diện nhẹ (có thể tối ưu thêm nếu cần) -->
                        <!-- Update Stock Modal -->
                        <div class="modal fade" id="updateStockModal{{ product['id'] }}" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content rounded-4 shadow">
                                    <div class="modal-header border-0">
                                        <h5 class="modal-title fw-bold">Cập nhật tồn kho</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="post" action="/products/{{ product['id'] }}/update">
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <strong>{{ product['name'] }}</strong>
                                                <span class="text-muted small d-block">Tồn hiện tại: {{ product['stock'] }}</span>
                                            </div>
                                            <div class="btn-group w-100 mb-3" role="group">
                                                <input type="radio" class="btn-check" name="type" id="in{{ product['id'] }}" value="in" checked>
                                                <label class="btn btn-outline-success rounded-start-pill" for="in{{ product['id'] }}">
                                                    <i class="bi bi-box-arrow-in-down me-2"></i>Nhập kho
                                                </label>
                                                <input type="radio" class="btn-check" name="type" id="out{{ product['id'] }}" value="out">
                                                <label class="btn btn-outline-danger rounded-end-pill" for="out{{ product['id'] }}">
                                                    <i class="bi bi-box-arrow-up me-2"></i>Xuất kho
                                                </label>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Số lượng</label>
                                                <input type="number" class="form-control rounded-pill" name="stock_change" min="1" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Ghi chú</label>
                                                <textarea class="form-control rounded-3" name="notes" rows="2"></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer border-0">
                                            <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Hủy</button>
                                            <button type="submit" class="btn btn-primary rounded-pill px-4">Cập nhật</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- View Product Modal (giữ nguyên phần lớn, chỉ thêm rounded-pill cho badge) -->
                        <!-- ... (giữ nội dung modal chi tiết như cũ, chỉ thay badge thành rounded-pill nếu muốn) ... -->

                        {% endfor %}
                    </tbody>
                </table>

                {% if products|length == 0 %}
                <div class="text-center py-5 bg-light rounded-bottom">
                    <i class="bi bi-inbox display-4 text-muted opacity-50"></i>
                    <h5 class="mt-4 text-muted">Không tìm thấy sản phẩm nào</h5>
                    <p class="text-muted">Thử thay đổi bộ lọc hoặc thêm sản phẩm mới.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add Product Modal (cải tiến layout form) -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Thêm sản phẩm mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="/products/add">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Tên sản phẩm *</label>
                                <input type="text" class="form-control rounded-pill" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">SKU *</label>
                                <input type="text" class="form-control rounded-pill" name="sku" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Danh mục *</label>
                                <select class="form-select rounded-pill" name="category" required>
                                    <option value="">Chọn danh mục</option>
                                    <option value="Điện tử">Điện tử</option>
                                    <option value="Phụ kiện">Phụ kiện</option>
                                    <option value="Linh kiện">Linh kiện</option>
                                    <option value="Văn phòng phẩm">Văn phòng phẩm</option>
                                    <option value="Gia dụng">Gia dụng</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Giá (VNĐ)</label>
                                <input type="number" class="form-control rounded-pill" name="price" step="1000">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-medium">Tồn kho ban đầu *</label>
                                <input type="number" class="form-control rounded-pill" name="stock" required min="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-medium">Tồn kho tối thiểu *</label>
                                <input type="number" class="form-control rounded-pill" name="min_stock" required min="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-medium">Vị trí kho</label>
                                <input type="text" class="form-control rounded-pill" name="location" placeholder="Kệ A1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Nhà cung cấp</label>
                                <input type="text" class="form-control rounded-pill" name="supplier">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-medium">Mô tả sản phẩm</label>
                                <textarea class="form-control rounded-3" name="description" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-4">Thêm sản phẩm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}